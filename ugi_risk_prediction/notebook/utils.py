import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns 

def convert_date_dx(date):
    """
    Convert an float date to datetime depending on the integer format. 
    If year only, will default specify Jan 01 [year]
    If year month only, will default specify [month] 01 [year]
    if year month and day specified, will convert to datetime representation
    
    Parameters:
    - date: array of floats specifying the date
    
    Returns:
    array of datetime with year, month and date 
    
    Example: 
        >>> convert_date_dx(df['date_dx']))
    """
    if date < 3000:
        return pd.to_datetime(date, format='%Y')
    elif 3000 <= date < 300000: 
        return pd.to_datetime(date, format='%Y%m')
    else:
        return pd.to_datetime(date, format='%Y%m%d')
    
def generate_bucket_barplot(column, bins, labels):
    """
    Generate a bucket table and plot a barplot showing the distribution of values in buckets.

    Parameters:
    - column: pandas Series or array-like, the input column containing the values to be categorized into buckets.
    - bins: array of ints specifying the bin cutoffs.
    - labels: array of strings specifying the bin labels. 
    
    Returns:
    None

    Example:
        >>> generate_bucket_barplot(df['date_dx'], [1000, 3000, 30000000], ['yyyy', 'yyyymmdd'])
    """
        
    # Use pd.cut to categorize values into buckets
    bucket_column = pd.cut(column, bins=bins, labels=labels)

    # Count the number of values in each bucket
    bucket_counts = bucket_column.value_counts().reset_index().sort_values(by='index').reset_index(drop=True)
    bucket_counts.columns = ['bucket', 'count']
    
    # Print the bucket table
    print("Bucket Table:")
    print(bucket_counts)

    # Plot the barplot
    sns.barplot(x='bucket', y='count', data=bucket_counts)
    plt.xlabel('Value Range')
    plt.ylabel('Count')
    plt.title('Distribution of Values in Buckets')

    # Add count labels on the bars
    for index, row in bucket_counts.iterrows():
        plt.text(index, row['count'], f"{row['count']}", color='black', ha="center")

    plt.show()
                 
COLNAMES_DEMTABLE = [
    'sex',
    'age',
    'race',
    'ethnicity',
    'preferred_language',
    'social_race',
    'social_ethnicity',
    'social_alcohol',
    'social_alcohol_binge_freq',
    'social_alcohol_drink_freq',
    'social_alcohol_drinks_day',
    'social_smoking_ever',
    'social_smoking_quit',
    'social_smoking_ppd',
    #     'social_smoking_narrative',
    #     'encounter_type',
    #     'care_site',
    'visit_year',
    'BMI_baseline',
    #     'BMI_baseline_val',
    #     'BMI_baseline_date',
    'BMI_prior',
    #      'BMI_prior_val',
    #      'BMI_prior_date',
    'hgball_baseline',
    #      'hgball_baseline_val',
    #      'hgball_baseline_date',
    #      'hgball_baseline_range_high',
    #      'hgball_baseline_range_low',
    'hgball_prior',
    #      'hgball_prior_val',
    #      'hgball_prior_date',
    #      'hgball_prior_range_high',
    #      'hgball_prior_range_low',
    'hgb_baseline',
    #      'hgb_baseline_val',
    #      'hgb_baseline_date',
    #      'hgb_baseline_range_high',
    #      'hgb_baseline_range_low',
    'hgb_prior',
    #      'hgb_prior_val',
    #      'hgb_prior_date',
    #      'hgb_prior_range_high',
    #      'hgb_prior_range_low',
    'mcv_baseline',
    #      'mcv_baseline_val',
    #      'mcv_baseline_date',
    #      'mcv_baseline_range_high',
    #      'mcv_baseline_range_low',
    'mcv_prior',
    #      'mcv_prior_val',
    #      'mcv_prior_date',
    #      'mcv_prior_range_high',
    #      'mcv_prior_range_low',
    'wbc_baseline',
    #      'wbc_baseline_val',
    #      'wbc_baseline_date',
    #      'wbc_baseline_range_high',
    #      'wbc_baseline_range_low',
    'wbc_prior',
    #      'wbc_prior_val',
    #      'wbc_prior_date',
    #      'wbc_prior_range_high',
    #      'wbc_prior_range_low',
    'plt_baseline',
    #      'plt_baseline_val',
    #      'plt_baseline_date',
    #      'plt_baseline_range_high',
    #      'plt_baseline_range_low',
    'plt_prior',
    #      'plt_prior_val',
    #      'plt_prior_date',
    #      'plt_prior_range_high',
    #      'plt_prior_range_low',
    'sodium_baseline',
    #      'sodium_baseline_val',
    #      'sodium_baseline_date',
    #      'sodium_baseline_range_high',
    #      'sodium_baseline_range_low',
    'sodium_prior',
    #      'sodium_prior_val',
    #      'sodium_prior_date',
    #      'sodium_prior_range_high',
    #      'sodium_prior_range_low',
    'potassium_baseline',
    #      'potassium_baseline_val',
    #      'potassium_baseline_date',
    #      'potassium_baseline_range_high',
    #      'potassium_baseline_range_low',
    'potassium_prior',
    #      'potassium_prior_val',
    #      'potassium_prior_date',
    #      'potassium_prior_range_high',
    #      'potassium_prior_range_low',
    'chloride_baseline',
    #      'chloride_baseline_val',
    #      'chloride_baseline_date',
    #      'chloride_baseline_range_high',
    #      'chloride_baseline_range_low',
    'chloride_prior',
    #      'chloride_prior_val',
    #      'chloride_prior_date',
    #      'chloride_prior_range_high',
    #      'chloride_prior_range_low',
    'bicarbonate_baseline',
    #      'bicarbonate_baseline_val',
    #      'bicarbonate_baseline_date',
    #      'bicarbonate_baseline_range_high',
    #      'bicarbonate_baseline_range_low',
    'bicarbonate_prior',
    #      'bicarbonate_prior_val',
    #      'bicarbonate_prior_date',
    #      'bicarbonate_prior_range_high',
    #      'bicarbonate_prior_range_low',
    'bun_baseline',
    #      'bun_baseline_val',
    #      'bun_baseline_date',
    #      'bun_baseline_range_high',
    #      'bun_baseline_range_low',
    'bun_prior',
    #      'bun_prior_val',
    #      'bun_prior_date',
    #      'bun_prior_range_high',
    #      'bun_prior_range_low',
    'scr_baseline',
    #      'scr_baseline_val',
    #      'scr_baseline_date',
    #      'scr_baseline_range_high',
    #      'scr_baseline_range_low',
    'scr_prior',
    #      'scr_prior_val',
    #      'scr_prior_date',
    #      'scr_prior_range_high',
    #      'scr_prior_range_low',
    'magnesium_baseline',
    #      'magnesium_baseline_val',
    #      'magnesium_baseline_date',
    #      'magnesium_baseline_range_high',
    #      'magnesium_baseline_range_low',
    'magnesium_prior',
    #      'magnesium_prior_val',
    #      'magnesium_prior_date',
    #      'magnesium_prior_range_high',
    #      'magnesium_prior_range_low',
    'calcium_baseline',
    #      'calcium_baseline_val',
    #      'calcium_baseline_date',
    #      'calcium_baseline_range_high',
    #      'calcium_baseline_range_low',
    'calcium_prior',
    #      'calcium_prior_val',
    #      'calcium_prior_date',
    #      'calcium_prior_range_high',
    #      'calcium_prior_range_low',
    'phosphate_baseline',
    #      'phosphate_baseline_val',
    #      'phosphate_baseline_date',
    #      'phosphate_baseline_range_high',
    #      'phosphate_baseline_range_low',
    'phosphate_prior',
    #      'phosphate_prior_val',
    #      'phosphate_prior_date',
    #      'phosphate_prior_range_high',
    #      'phosphate_prior_range_low',
    'ast_baseline',
    #      'ast_baseline_val',
    #      'ast_baseline_date',
    #      'ast_baseline_range_high',
    #      'ast_baseline_range_low',
    'ast_prior',
    #      'ast_prior_val',
    #      'ast_prior_date',
    #      'ast_prior_range_high',
    #      'ast_prior_range_low',
    'alt_baseline',
    #      'alt_baseline_val',
    #      'alt_baseline_date',
    #      'alt_baseline_range_high',
    #      'alt_baseline_range_low',
    'alt_prior',
    #      'alt_prior_val',
    #      'alt_prior_date',
    #      'alt_prior_range_high',
    #      'alt_prior_range_low',
    'alp_baseline',
    #      'alp_baseline_val',
    #      'alp_baseline_date',
    #      'alp_baseline_range_high',
    #      'alp_baseline_range_low',
    'alp_prior',
    #      'alp_prior_val',
    #      'alp_prior_date',
    #      'alp_prior_range_high',
    #      'alp_prior_range_low',
    'tbili_baseline',
    #      'tbili_baseline_val',
    #      'tbili_baseline_date',
    #      'tbili_baseline_range_high',
    #      'tbili_baseline_range_low',
    'tbili_prior',
    #      'tbili_prior_val',
    #      'tbili_prior_date',
    #      'tbili_prior_range_high',
    #      'tbili_prior_range_low',
    'tprotein_baseline',
    #      'tprotein_baseline_val',
    #      'tprotein_baseline_date',
    #      'tprotein_baseline_range_high',
    #      'tprotein_baseline_range_low',
    'tprotein_prior',
    #      'tprotein_prior_val',
    #      'tprotein_prior_date',
    #      'tprotein_prior_range_high',
    #      'tprotein_prior_range_low',
    'albumin_baseline',
    #      'albumin_baseline_val',
    #      'albumin_baseline_date',
    #      'albumin_baseline_range_high',
    #      'albumin_baseline_range_low',
    'albumin_prior',
    #      'albumin_prior_val',
    #      'albumin_prior_date',
    #      'albumin_prior_range_high',
    #      'albumin_prior_range_low',
    'tsh_baseline',
    #      'tsh_baseline_val',
    #      'tsh_baseline_date',
    #      'tsh_baseline_range_high',
    #      'tsh_baseline_range_low',
    'tsh_prior',
    #      'tsh_prior_val',
    #      'tsh_prior_date',
    #      'tsh_prior_range_high',
    #      'tsh_prior_range_low',
    'vitD_baseline',
    #      'vitD_baseline_val',
    #      'vitD_baseline_date',
    #      'vitD_baseline_range_high',
    #      'vitD_baseline_range_low',
    'vitD_prior',
    #      'vitD_prior_val',
    #      'vitD_prior_date',
    #      'vitD_prior_range_high',
    #      'vitD_prior_range_low',
    'triglycerides_baseline',
    #      'triglycerides_baseline_val',
    #      'triglycerides_baseline_date',
    #      'triglycerides_baseline_range_high',
    #      'triglycerides_baseline_range_low',
    'triglycerides_prior',
    #      'triglycerides_prior_val',
    #      'triglycerides_prior_date',
    #      'triglycerides_prior_range_high',
    #      'triglycerides_prior_range_low',
    'LDL_baseline',
    #      'LDL_baseline_val',
    #      'LDL_baseline_date',
    #      'LDL_baseline_range_high',
    #      'LDL_baseline_range_low',
    'LDL_prior',
    #      'LDL_prior_val',
    #      'LDL_prior_date',
    #      'LDL_prior_range_high',
    #      'LDL_prior_range_low',
    'hgba1c_baseline',
    #      'hgba1c_baseline_val',
    #      'hgba1c_baseline_date',
    #      'hgba1c_baseline_range_high',
    #      'hgba1c_baseline_range_low',
    'hgba1c_prior',
    #      'hgba1c_prior_val',
    #      'hgba1c_prior_date',
    #      'hgba1c_prior_range_high',
    #      'hgba1c_prior_range_low',
    #      'hpylori_earliest_date',
    #      'hpylori_earliest_value',
    #      'hpylori_earliest_range_high',
    #      'hpylori_earliest_range_low',
    'hpylori_earliest_result_num',
    'hpylori_earliest_test',
    #      'hpylori_stool_date',
    'hpylori_stool_value',
    #      'hpylori_stool_range_high',
    #      'hpylori_stool_range_low',
    #      'hpylori_iga_date',
    'hpylori_iga_value',
    #      'hpylori_iga_range_high',
    #      'hpylori_iga_range_low',
    #      'hpylori_igm_date',
    'hpylori_igm_value',
    #      'hpylori_igm_range_high',
    #      'hpylori_igm_range_low',
    #      'hpylori_igg_date',
    'hpylori_igg_value',
    #      'hpylori_igg_range_high',
    #      'hpylori_igg_range_low',
    #      'hpylori_breath_date',
    'hpylori_breath_value',
    #      'hpylori_breath_range_high',
    #      'hpylori_breath_range_low',
    #      'gastricca_start_date',
    'gastricca',
    #      'esophagealca_start_date',
    'esophagealca',
    #      'hnca_start_date',
    'hnca',
    #      'achalasia_start_date',
    'achalasia',
    #      'pud_start_date',
    'pud',
    #      'gerd_start_date',
    'gerd',
    #      'hpylori_start_date',
    'hpylori',
    #      'cad_start_date',
    'cad',
    #      'tobacco_start_date',
    'tobacco',
    #      'alcohol_start_date',
    'alcohol',
    'famhx_cancer',
    'famhx_esophagealca',
    'famhx_gastricca',
    'famhx_colonca',
    #      'ASA_start_date',
    #      'NSAID_start_date',
    #      'PPI_start_date',
    'PPI',
    'ASA',
    'NSAID',
    'primary_tumor_site',
    'ugica_stomach',
    'ugica_smallintestine',
    'ugica_esophagus'
]
                 
CATEGORICAL_COLNAMES_DEMTABLE = [
    'sex',
    'race',
    'ethnicity',
    'preferred_language',
    'social_race',
    'social_ethnicity',
    'social_alcohol',
    'social_alcohol_binge_freq',
    'social_alcohol_drink_freq',
    'social_alcohol_drinks_day',
    'social_smoking_ever',
    'social_smoking_quit',
    'social_smoking_ppd',
    'hpylori_earliest_test',
    'hpylori_stool_value',
    'hpylori_breath_value',
    'gastricca',
    'esophagealca',
    'hnca',
    'achalasia',
    'pud',
    'gerd',
    'hpylori',
    'cad',
    'tobacco',
    'alcohol',
    'famhx_cancer',
    'famhx_esophagealca',
    'famhx_gastricca',
    'famhx_colonca',
    'primary_tumor_site',
    'ugica_stomach',
    'ugica_smallintestine',
    'ugica_esophagus'
]